sudo: required
language: node_js
node_js:
- 7
addons:
  apt:
    source:
    - ubuntu-toolchain-r-test
    packages:
    - build-essential
    - google-chrome-stable
    - libcairo2-dev
    - libjpeg8-dev
    - libpango1.0-dev
    - libgif-dev
    - g++-4.8

services:
- docker

cache:
  pip: true
  directories:
  - node_modules

before_install:
- pip install -U pip --user travis
- pip install flake8 --user travis

install:
- cd $TRAVIS_BUILD_DIR/containers/datalab
- ./build.sh

script:
- cd $TRAVIS_BUILD_DIR/tools/
- flake8 cli/
- cd $TRAVIS_BUILD_DIR/test
- npm install -s -q --depth 0
- npm test
- for i in `ls ui/broken/`; do echo ui/broken/$i; base64 ui/broken/$i; echo \"-----\"; done
- cd $TRAVIS_BUILD_DIR/sources/web/datalab/polymer/test
- export DISPLAY=:99.0
- export TEST_LOG="${HOME}/${TRAVIS_JOB_NUMBER}_npm_test.log"
- timeout 2m bash -c "npm test -- --verbose -l chrome | tee '${TEST_LOG}'; exit ${PIPESTATUS[0]}" || grep "Tests passed" "${TEST_LOG}"
- timeout 3m bash -c "npm test -- --verbose -l firefox | tee '${TEST_LOG}'; exit ${PIPESTATUS[0]}" || grep "Tests passed" "${TEST_LOG}"
