<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">

<link rel="import" href="../../custom_components/datalab-sidebar/datalab-sidebar.html">
<link rel="import" href="../../custom_components/datalab-toolbar/datalab-toolbar.html">
<link rel="import" href="../../custom_components/datalab-files/datalab-files.html">
<link rel="import" href="../../custom_components/datalab-sessions/datalab-sessions.html">

<dom-module id="datalab-app">
  <template>
    <style>
      #container {
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .datalab-contents {
        display: flex;
        flex-grow: 1;
      }
      .datalab-sidebar {
        width: 200px;
      }
      .datalab-main-content {
        flex-grow: 1;
        box-shadow: -4px 0px 10px -3px rgba(0, 0, 0, 0.1);
        height: calc(100% - var(--toolbar-height));
      }
      iron-pages {
        height: 100%;
      }
    </style>

    <app-location route="{{route}}"></app-location>
    <app-route
        route="{{route}}"
        pattern="[[rootPattern]]:page"
        data="{{routeData}}"
        tail="{{subroute}}"></app-route>

    <div id="container">
      <datalab-toolbar></datalab-toolbar>
      <div class="datalab-contents">
        <div class="datalab-sidebar">
          <datalab-sidebar page=[[page]]></datalab-sidebar>
        </div>
        <div class="datalab-main-content">
          <iron-pages selected="{{page}}" attr-for-selected="name" fallback-selection="files">
            <datalab-files name="files"></datalab-files>
            <datalab-sessions name="sessions"></datalab-sessions>
          </iron-pages>
        </div>
      </div>
    </div>

  </template>
</dom-module>

<script>
  class DatalabAppElement extends Polymer.Element {

    static get is() { return "datalab-app"; }

    static get properties() {
      return {
        page: {
          type: String,
          value: "files",
          observer: '_pageChanged'
        },
        rootPattern: String,
        routeData: Object,
        subroute: String,
      }
    }

    static get observers() {
      return [
        // need a complex observer for changes to the routeData object's page property
        '_routePageChanged(routeData.page)',
      ];
    }

    constructor() {
      super();
      this.rootPattern = (new URL(this.rootPath)).pathname;
    }

    _routePageChanged(page) {
      // default to the files view
      this.page = page || 'files';
    }

    _pageChanged(page) {
      // import page on demand and then load it
      // build the path using the page name as suffix for directory and file names
      let subpath = 'datalab-' + page
      var resolvedPageUrl = this.resolveUrl('../' + subpath + '/' + subpath + '.html');
      Polymer.importHref(resolvedPageUrl, null, null, true);
    }

  }

  customElements.define(DatalabAppElement.is, DatalabAppElement);
</script>
